{% extends "layout.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
    <div class="page-header">
        <div class="page-header__content">
            <h1 class="page-header__title">System Settings</h1>
        </div>
        <div class="page-header__actions">
            <button class="btn" onclick="window.location.href='{{ url_for('index') }}'">
                <span class="btn__label">
                    <i data-lucide="arrow-left" class="btn__icon"></i>
                    Back to Dashboard
                </span>
            </button>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="toast-container" id="toast-container">
            {% for category, message in messages %}
                <div class="toast toast--{{ 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'error' }}" onclick="dismissToast(this)">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <form id="settings-form" action="{{ url_for('save_settings') }}" method="POST">
        <div class="card u-mb-3">
            <div class="card__header">
                <h2 class="card__title">
                    <i data-lucide="settings" class="btn__icon"></i>
                    Environment
                </h2>
            </div>
            <div class="card__body">
                <div class="form-group u-mb-3">
                    <label class="form-group__label">Environment Mode</label>
                    <div class="u-flex u-flex-gap-2">
                        <label class="u-flex u-items-center u-flex-gap-1">
                            <input type="radio" name="environment" value="production"
                                   {{ 'checked' if config.get('system', {}).get('environment') == 'production' else '' }}>
                            <span>Production</span>
                        </label>
                        <label class="u-flex u-items-center u-flex-gap-1">
                            <input type="radio" name="environment" value="development"
                                   {{ 'checked' if config.get('system', {}).get('environment') == 'development' else '' }}>
                            <span>Development</span>
                        </label>
                    </div>
                    <small class="u-text-muted">
                        Development mode enables debug features and auto-reloading of templates.
                        <strong>Do not use in production.</strong>
                    </small>
                </div>

                <div class="form-group u-mb-3">
                    <label for="hostname" class="form-group__label">Hostname / IP Address</label>
                    <input type="text" id="hostname" name="hostname" class="form-group__input"
                           value="{{ config.get('system', {}).get('hostname', 'localhost') }}">
                    <small class="u-text-muted">Public hostname or IP address for accessing HiveMatrix.</small>
                </div>

                <div class="form-group">
                    <label for="log_level" class="form-group__label">Log Level</label>
                    <select id="log_level" name="log_level" class="form-group__select">
                        {% set current_level = config.get('system', {}).get('log_level', 'INFO') %}
                        <option value="DEBUG" {{ 'selected' if current_level == 'DEBUG' else '' }}>DEBUG</option>
                        <option value="INFO" {{ 'selected' if current_level == 'INFO' else '' }}>INFO</option>
                        <option value="WARNING" {{ 'selected' if current_level == 'WARNING' else '' }}>WARNING</option>
                        <option value="ERROR" {{ 'selected' if current_level == 'ERROR' else '' }}>ERROR</option>
                        <option value="CRITICAL" {{ 'selected' if current_level == 'CRITICAL' else '' }}>CRITICAL</option>
                    </select>
                    <small class="u-text-muted">Logging verbosity for all services.</small>
                </div>

                <div class="u-mt-3">
                    <button type="button" class="btn btn--primary" onclick="document.getElementById('settings-form').submit()">
                        <span class="btn__label">
                            <i data-lucide="save" class="btn__icon"></i>
                            Save Settings
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <div class="card u-mb-3">
            <div class="card__header">
                <h2 class="card__title">
                    <i data-lucide="database" class="btn__icon"></i>
                    Database Configuration
                </h2>
            </div>
            <div class="card__body">
                <div class="u-flex u-flex-gap-2 u-flex-wrap">
                    <div style="flex: 1; min-width: 200px;">
                        <p class="u-mb-1"><strong>PostgreSQL</strong></p>
                        <p class="u-text-muted u-text-sm">
                            Host: {{ config.get('databases', {}).get('postgresql', {}).get('host', 'localhost') }}<br>
                            Port: {{ config.get('databases', {}).get('postgresql', {}).get('port', 5432) }}
                        </p>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <p class="u-mb-1"><strong>Neo4j</strong></p>
                        <p class="u-text-muted u-text-sm">
                            URI: {{ config.get('databases', {}).get('neo4j', {}).get('uri', 'bolt://localhost:7687') }}
                        </p>
                    </div>
                </div>
                <p class="u-text-muted u-mt-2 u-text-sm">
                    <i data-lucide="info" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                    Edit master_config.json directly to change database settings.
                </p>
            </div>
        </div>

        <div class="card u-mb-3">
            <div class="card__header">
                <h2 class="card__title">
                    <i data-lucide="key" class="btn__icon"></i>
                    Keycloak Configuration
                </h2>
            </div>
            <div class="card__body">
                <p class="u-text-muted u-text-sm">
                    URL: {{ config.get('keycloak', {}).get('url', 'http://localhost:8080') }}<br>
                    Realm: {{ config.get('keycloak', {}).get('realm', 'hivematrix') }}<br>
                    Client ID: {{ config.get('keycloak', {}).get('client_id', 'core-client') }}
                </p>
                <p class="u-text-muted u-mt-2 u-text-sm">
                    <i data-lucide="info" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                    Edit master_config.json directly to change Keycloak settings.
                </p>
            </div>
        </div>

    </form>

    <div class="card u-mb-3">
        <div class="card__header">
            <h2 class="card__title">
                <i data-lucide="refresh-cw" class="btn__icon"></i>
                Service Management
            </h2>
        </div>
        <div class="card__body">
            <p class="u-text-muted u-mb-3">Sync configuration to all services or restart all running services to apply changes.</p>
            <div class="u-flex u-flex-gap u-flex-wrap">
                <form action="{{ url_for('sync_config') }}" method="POST" class="u-inline">
                    <button type="submit" class="btn btn--secondary">
                        <span class="btn__label">
                            <i data-lucide="copy" class="btn__icon"></i>
                            Sync Configuration
                        </span>
                    </button>
                </form>
                <form action="{{ url_for('restart_all_services') }}" method="POST" class="u-inline" onsubmit="return confirm('Restart all running services? This will briefly interrupt service.');">
                    <button type="submit" class="btn btn--warning">
                        <span class="btn__label">
                            <i data-lucide="rotate-cw" class="btn__icon"></i>
                            Restart All Services
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="card u-mb-3">
        <div class="card__header">
            <h2 class="card__title">
                <i data-lucide="shield-check" class="btn__icon"></i>
                SSL Certificate
            </h2>
        </div>
        <div class="card__body">
            <div id="ssl-info">
                <p class="u-text-muted">Loading certificate information...</p>
            </div>
        </div>
    </div>

    <div class="card u-mb-3">
        <div class="card__header">
            <h2 class="card__title">
                <i data-lucide="archive" class="btn__icon"></i>
                Backup
            </h2>
        </div>
        <div class="card__body">
            <p class="u-text-muted u-mb-3">Create a backup of all databases and configuration. Full backups require sudo access.</p>
            <form action="{{ url_for('trigger_backup') }}" method="POST" class="u-inline">
                <button type="submit" class="btn btn--secondary">
                    <span class="btn__label">
                        <i data-lucide="download" class="btn__icon"></i>
                        Test Backup
                    </span>
                </button>
            </form>
            <p class="u-text-muted u-mt-2 u-text-sm">
                <i data-lucide="terminal" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                For full backup, run: <code>sudo python3 backup.py</code>
            </p>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
        // Load SSL certificate info
        fetch('{{ url_for("ssl_info") }}')
            .then(response => response.json())
            .then(data => {
                const sslDiv = document.getElementById('ssl-info');
                if (data.exists) {
                    sslDiv.innerHTML = `
                        <p class="u-mb-1"><strong>Subject:</strong> ${data.subject || 'N/A'}</p>
                        <p class="u-mb-1"><strong>Issuer:</strong> ${data.issuer || 'N/A'}</p>
                        <p class="u-mb-1"><strong>Expires:</strong> ${data.expires || 'N/A'}</p>
                        <p class="u-text-muted u-mt-2 u-text-sm">
                            <i data-lucide="info" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                            Certificate location: ${data.path}
                        </p>
                    `;
                } else {
                    sslDiv.innerHTML = `
                        <p class="u-text-warning">No SSL certificate found.</p>
                        <p class="u-text-muted u-text-sm">Generate a certificate in hivematrix-nexus/certs/</p>
                    `;
                }
                lucide.createIcons();
            })
            .catch(error => {
                document.getElementById('ssl-info').innerHTML = `
                    <p class="u-text-danger">Error loading certificate info: ${error.message}</p>
                `;
            });

        lucide.createIcons();

        // Toast notification auto-dismiss
        function dismissToast(toast) {
            toast.classList.add('toast--hiding');
            setTimeout(() => toast.remove(), 300);
        }

        // Auto-dismiss toasts after 5 seconds
        document.querySelectorAll('.toast').forEach(toast => {
            setTimeout(() => dismissToast(toast), 5000);
        });
</script>
{% endblock %}
