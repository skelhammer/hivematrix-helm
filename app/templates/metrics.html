{% extends "layout.html" %}

{% block title %}Metrics{% endblock %}

{% block content %}
    <div class="container">
        <div class="card u-mb-3">
            <div class="card__header">
                <h1 class="card__title">Performance Metrics</h1>
                <div class="card__header-actions">
                    <button class="btn" onclick="navigateTo('/')">
                        <span class="btn__label">
                            <i data-lucide="arrow-left" class="btn__icon"></i>
                            Back to Dashboard
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <div class="card u-mb-3">
            <div class="card__header">
                <h2 class="card__title">Service Resource Usage</h2>
            </div>
            <div class="card__body">
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Health</th>
                            <th>Port</th>
                            <th>PID</th>
                            <th>CPU %</th>
                            <th>Memory (MB)</th>
                            <th>Uptime</th>
                            <th>Logs (1h)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service_name, status in statuses.items() %}
                        <tr>
                            <td>
                                <a href="#" onclick="navigateTo('/service/{{ service_name }}'); return false;">{{ service_name }}</a>
                            </td>
                            <td>
                                <span class="status-text status-text--{{ 'success' if status.status == 'running' else 'danger' }}">
                                    {{ status.status }}
                                </span>
                            </td>
                            <td>
                                <span class="status-text status-text--{{ 'success' if status.health == 'healthy' else 'warning' if status.health == 'degraded' else 'danger' }}">
                                    {{ status.health }}
                                </span>
                            </td>
                            <td>{{ status.configured_port or 'N/A' }}</td>
                            <td>{{ status.pid or '-' }}</td>
                            <td>
                                {% if status.cpu_percent is not none %}
                                    {{ "%.1f"|format(status.cpu_percent) }}%
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if status.memory_mb is not none %}
                                    {{ "%.1f"|format(status.memory_mb) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ status.uptime }}</td>
                            <td>
                                {% set stats = log_stats.get(service_name, {}) %}
                                {% if stats %}
                                    <span class="log-stats">
                                        {% if stats.get('ERROR', 0) > 0 %}
                                            <span class="status-text status-text--danger">E: {{ stats.get('ERROR', 0) }}</span>
                                        {% endif %}
                                        {% if stats.get('WARNING', 0) > 0 %}
                                            <span class="status-text status-text--warning">W: {{ stats.get('WARNING', 0) }}</span>
                                        {% endif %}
                                        {% if stats.get('INFO', 0) > 0 %}
                                            <span class="status-text status-text--info">I: {{ stats.get('INFO', 0) }}</span>
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="log-stats">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card__header">
                <h2 class="card__title">System Information</h2>
            </div>
            <div class="card__body">
                <p><em>Historical metrics and charts would go here.</em></p>
                <p>Use the API endpoint <code>/api/metrics/&lt;service_name&gt;</code> to retrieve time-series data.</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/helm/')) {
                return '/helm';
            }
            return '';
        }

        function navigateTo(path) {
            const basePath = getBasePath();
            window.location.href = basePath + path;
        }

        // Initialize Lucide icons
        window.addEventListener('load', () => {
            lucide.createIcons();
        });

        // Auto-refresh every 5 seconds
        setTimeout(() => location.reload(), 5000);
</script>
{% endblock %}
